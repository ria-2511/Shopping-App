!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)}(function(d){"use strict";function r(){this.posFrom=this.posTo=this.lastQuery=this.query=null,this.overlay=null}function y(e){return e.state.search||(e.state.search=new r)}function a(e){return"string"==typeof e&&e==e.toLowerCase()}function m(e,r,n){return e.getSearchCursor(r,n,{caseFold:a(r),multiline:!0})}function h(e,r,n,o,t){e.openDialog?e.openDialog(r,t,{value:o,selectValueOnOpen:!0}):t(prompt(n,o))}function o(e){return e.replace(/\\([nrt\\])/g,function(e,r){return"n"==r?"\n":"r"==r?"\r":"t"==r?"\t":"\\"==r?"\\":e})}function i(e){var r=e.match(/^\/(.*)\/([a-z]*)$/);if(r)try{e=new RegExp(r[1],-1==r[2].indexOf("i")?"":"i")}catch(e){}else e=o(e);return("string"==typeof e?""==e:e.test(""))&&(e=/x^/),e}function g(e,r,n){var o,t;r.queryText=n,r.query=i(n),e.removeOverlay(r.overlay,a(r.query)),r.overlay=(o=r.query,t=a(r.query),"string"==typeof o?o=new RegExp(o.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),t?"gi":"g"):o.global||(o=new RegExp(o.source,o.ignoreCase?"gi":"g")),{token:function(e){o.lastIndex=e.pos;var r=o.exec(e.string);if(r&&r.index==e.pos)return e.pos+=r[0].length||1,"searching";r?e.pos=r.index:e.skipToEnd()}}),e.addOverlay(r.overlay),e.showMatchesOnScrollbar&&(r.annotate&&(r.annotate.clear(),r.annotate=null),r.annotate=e.showMatchesOnScrollbar(r.query,a(r.query)))}function n(a,r,e,n){var o=y(a);if(o.query)return v(a,r);var t,i,s,c,l,u=a.getSelection()||o.lastQuery;if(u instanceof RegExp&&"x^"==u.source&&(u=null),e&&a.openDialog){var f=null,p=function(e,r){d.e_stop(r),e&&(e!=o.queryText&&(g(a,o,e),o.posFrom=o.posTo=a.getCursor()),f&&(f.style.opacity=1),v(a,r.shiftKey,function(e,r){var n;r.line<3&&document.querySelector&&(n=a.display.wrapper.querySelector(".CodeMirror-dialog"))&&n.getBoundingClientRect().bottom-4>a.cursorCoords(r,"window").top&&((f=n).style.opacity=.4)}))};i=C(t=a),s=u,c=p,l=function(e,r){var n=d.keyName(e),o=a.getOption("extraKeys"),t=o&&o[n]||d.keyMap[a.getOption("keyMap")][n];"findNext"==t||"findPrev"==t||"findPersistentNext"==t||"findPersistentPrev"==t?(d.e_stop(e),g(a,y(a),r),a.execCommand(t)):"find"!=t&&"findPersistent"!=t||(d.e_stop(e),p(r,e))},t.openDialog(i,c,{value:s,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){x(t)},onKeyDown:l}),n&&u&&(g(a,o,u),v(a,r))}else h(a,C(a),"Search for:",u,function(e){e&&!o.query&&a.operation(function(){g(a,o,e),o.posFrom=o.posTo=a.getCursor(),v(a,r)})})}function v(n,o,t){n.operation(function(){var e=y(n),r=m(n,e.query,o?e.posFrom:e.posTo);(r.find(o)||(r=m(n,e.query,o?d.Pos(n.lastLine()):d.Pos(n.firstLine(),0))).find(o))&&(n.setSelection(r.from(),r.to()),n.scrollIntoView({from:r.from(),to:r.to()},20),e.posFrom=r.from(),e.posTo=r.to(),t&&t(r.from(),r.to()))})}function x(r){r.operation(function(){var e=y(r);e.lastQuery=e.query,e.query&&(e.query=e.queryText=null,r.removeOverlay(e.overlay),e.annotate&&(e.annotate.clear(),e.annotate=null))})}function C(e){return'<span class="CodeMirror-search-label">'+e.phrase("Search:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+e.phrase("(Use /re/ syntax for regexp search)")+"</span>"}function q(r,o,t){r.operation(function(){for(var e=m(r,o);e.findNext();)if("string"!=typeof o){var n=r.getRange(e.from(),e.to()).match(o);e.replace(t.replace(/\$(\d)/g,function(e,r){return n[r]}))}else e.replace(t)})}function t(p,e){if(!p.getOption("readOnly")){var r=p.getSelection()||y(p).lastQuery,n='<span class="CodeMirror-search-label">'+(e?p.phrase("Replace all:"):p.phrase("Replace:"))+"</span>";h(p,n+(' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+p.phrase("(Use /re/ syntax for regexp search)")+"</span>"),n,r,function(f){f&&(f=i(f),h(p,'<span class="CodeMirror-search-label">'+p.phrase("With:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/>',p.phrase("Replace with:"),"",function(s){if(s=o(s),e)q(p,f,s);else{x(p);var c=m(p,f,p.getCursor("from")),l=function(){var e,r,n,o,t,a,i=c.from();!(e=c.findNext())&&(c=m(p,f),!(e=c.findNext())||i&&c.from().line==i.line&&c.from().ch==i.ch)||(p.setSelection(c.from(),c.to()),p.scrollIntoView({from:c.from(),to:c.to()}),n='<span class="CodeMirror-search-label">'+(a=r=p).phrase("Replace?")+"</span> <button>"+a.phrase("Yes")+"</button> <button>"+a.phrase("No")+"</button> <button>"+a.phrase("All")+"</button> <button>"+a.phrase("Stop")+"</button> ",o=p.phrase("Replace?"),t=[function(){u(e)},l,function(){q(p,f,s)}],r.openConfirm?r.openConfirm(n,t):confirm(o)&&t[0]())},u=function(n){c.replace("string"==typeof f?s:s.replace(/\$(\d)/g,function(e,r){return n[r]})),l()};l()}}))})}}d.commands.find=function(e){x(e),n(e)},d.commands.findPersistent=function(e){x(e),n(e,!1,!0)},d.commands.findPersistentNext=function(e){n(e,!1,!0,!0)},d.commands.findPersistentPrev=function(e){n(e,!0,!0,!0)},d.commands.findNext=n,d.commands.findPrev=function(e){n(e,!0)},d.commands.clearSearch=x,d.commands.replace=t,d.commands.replaceAll=function(e){t(e,!0)}});
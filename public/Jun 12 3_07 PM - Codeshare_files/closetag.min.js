!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("../fold/xml-fold")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../fold/xml-fold"],e):e(CodeMirror)}(function(y){y.defineOption("autoCloseTags",!1,function(e,t,n){if(n!=y.Init&&n&&e.removeKeyMap("autoCloseTags"),t){var o={name:"autoCloseTags"};"object"==typeof t&&!t.whenClosing||(o["'/'"]=function(e){return(t=e).getOption("disableInput")?y.Pass:r(t,!0);var t}),"object"==typeof t&&!t.whenOpening||(o["'>'"]=function(e){return function(e){if(e.getOption("disableInput"))return y.Pass;for(var t=e.listSelections(),n=[],o=e.getOption("autoCloseTags"),r=0;r<t.length;r++){if(!t[r].empty())return y.Pass;var i=t[r].head,a=e.getTokenAt(i),l=y.innerMode(e.getMode(),a.state),s=l.state,d=l.mode.xmlCurrentTag&&l.mode.xmlCurrentTag(s),c=d&&d.name;if(!c)return y.Pass;var f="html"==l.mode.configuration,g="object"==typeof o&&o.dontCloseTags||f&&x,u="object"==typeof o&&o.indentTags||f&&P;a.end>i.ch&&(c=c.slice(0,c.length-a.end+i.ch));var m=c.toLowerCase();if(!c||"string"==a.type&&(a.end!=i.ch||!/[\"\']/.test(a.string.charAt(a.string.length-1))||1==a.string.length)||"tag"==a.type&&d.close||a.string.indexOf("/")==i.ch-a.start-1||g&&-1<T(g,m)||j(e,l.mode.xmlCurrentContext&&l.mode.xmlCurrentContext(s)||[],c,i,!0))return y.Pass;var h="object"==typeof o&&o.emptyTags;if(h&&-1<T(h,c))n[r]={text:"/>",newPos:y.Pos(i.line,i.ch+2)};else{var p=u&&-1<T(u,m);n[r]={indent:p,text:">"+(p?"\n\n":"")+"</"+c+">",newPos:p?y.Pos(i.line+1,0):y.Pos(i.line,i.ch+1)}}}var v="object"==typeof o&&o.dontIndentOnAutoClose;for(r=t.length-1;0<=r;r--){var C=n[r];e.replaceRange(C.text,t[r].head,t[r].anchor,"+insert");var b=e.listSelections().slice(0);b[r]={head:C.newPos,anchor:C.newPos},e.setSelections(b),!v&&C.indent&&(e.indentLine(C.newPos.line,null,!0),e.indentLine(C.newPos.line+1,null,!0))}}(e)}),e.addKeyMap(o)}});var x=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],P=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"];function r(e,t){for(var n=e.listSelections(),o=[],r=t?"/":"</",i=e.getOption("autoCloseTags"),a="object"==typeof i&&i.dontIndentOnSlash,l=0;l<n.length;l++){if(!n[l].empty())return y.Pass;var s=n[l].head,d=e.getTokenAt(s),c=y.innerMode(e.getMode(),d.state),f=c.state;if(t&&("string"==d.type||"<"!=d.string.charAt(0)||d.start!=s.ch-1))return y.Pass;var g,u="xml"!=c.mode.name&&"htmlmixed"==e.getMode().name;if(u&&"javascript"==c.mode.name)g=r+"script";else if(u&&"css"==c.mode.name)g=r+"style";else{var m=c.mode.xmlCurrentContext&&c.mode.xmlCurrentContext(f);if(!m||m.length&&j(e,m,m[m.length-1],s))return y.Pass;g=r+m[m.length-1]}">"!=e.getLine(s.line).charAt(d.end)&&(g+=">"),o[l]=g}if(e.replaceSelections(o),n=e.listSelections(),!a)for(l=0;l<n.length;l++)(l==n.length-1||n[l].head.line<n[l+1].head.line)&&e.indentLine(n[l].head.line)}function T(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0,o=e.length;n<o;++n)if(e[n]==t)return n;return-1}function j(e,t,n,o,r){if(y.scanForClosingTag){var i=Math.min(e.lastLine()+1,o.line+500),a=y.scanForClosingTag(e,o,null,i);if(a&&a.tag==n){for(var l=r?1:0,s=t.length-1;0<=s&&t[s]==n;s--)++l;o=a.to;for(s=1;s<l;s++){var d=y.scanForClosingTag(e,o,null,i);if(!d||d.tag!=n)return;o=d.to}return 1}}}y.commands.closeTag=function(e){return r(e)}});